@page "/contacts"
@using Radzen
@inject CookieHelper CookieHelper
@inject NavigationManager NavigationManager
@inject IMessageService MessageService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Contacts</PageTitle>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (string.IsNullOrEmpty(userName))
{
    <div class="alert alert-warning">Please login to manage contacts.</div>
}
else
{
    <RadzenButton Text="Add Contact" Icon="add_circle" Click="@AddContact" Style="margin-bottom:10px" />
    <RadzenDataGrid Data="@contacts" TItem="ContactModel" @ref="grid">
        <Columns>
            <RadzenDataGridColumn TItem="ContactModel" Property="Name" Title="Name" />
            <RadzenDataGridColumn TItem="ContactModel" Property="PhoneNumber" Title="Phone" />
            <RadzenDataGridColumn TItem="ContactModel" Title="Actions">
                <Template Context="contact">
                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(() => EditContact(contact))" Style="margin-right:5px" />
                    <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => OnDeleteContact(contact))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    private string? userName;
    private bool isLoaded;
    private List<ContactModel> contacts = new();
    RadzenDataGrid<ContactModel>? grid;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            userName = await CookieHelper.LoginStatus();
            if (string.IsNullOrEmpty(userName))
            {
                NavigationManager.NavigateTo("login?returnUrl=/contacts", true);
            }
            else
            {
                contacts = (await MessageService.GetContacts()).ToList();
            }
            isLoaded = true;
            StateHasChanged();
        }
    }

    async Task AddContact()
    {
        var result = await DialogService.OpenAsync<ContactDialog>("Add Contact", new Dictionary<string, object>
        {
            { "Contact", new ContactModel() }
        });
        if (result is ContactModel contact)
        {
            await MessageService.SaveContact(contact);
            contacts = (await MessageService.GetContacts()).ToList();
            NotificationService.Notify(NotificationSeverity.Success, "Contact added");
        }
    }

    async Task EditContact(ContactModel contact)
    {
        var result = await DialogService.OpenAsync<ContactDialog>("Edit Contact", new Dictionary<string, object>
        {
            { "Contact", contact }
        });
        if (result is ContactModel updated)
        {
            await MessageService.SaveContact(updated);
            contacts = (await MessageService.GetContacts()).ToList();
            NotificationService.Notify(NotificationSeverity.Success, "Contact updated");
        }
    }

    async Task OnDeleteContact(ContactModel contact)
    {
        bool? confirm = await DialogService.Confirm("Are you sure you want to delete this contact?", "Delete Contact");
        if (confirm == true)
        {
            await MessageService.DeleteContact(contact.Id);
            contacts.Remove(contact);
            NotificationService.Notify(NotificationSeverity.Success, "Contact deleted");
            await grid!.Reload();
        }
    }
}
